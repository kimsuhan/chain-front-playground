"use client";

import { useState } from "react";
import { TrendingUp, Plus, Coins } from "lucide-react";
import { ethers } from "ethers";

const CTOKEN_ABI = [
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "underlying_",
        "type": "address"
      },
      {
        "internalType": "contract Comptroller",
        "name": "comptroller_",
        "type": "address"
      },
      {
        "internalType": "contract InterestRateModel",
        "name": "interestRateModel_",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "reserveFactorMantissa_",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name_",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "symbol_",
        "type": "string"
      }
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  }
];

const CTOKEN_BYTECODE = "0x608060405234801561001057600080fd5b50604051613048380380613048833981810160405281019061003291906103ce565b8181816003908161004391906106aa565b50806004908161005391906106aa565b505050600160058190555085600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555084600760006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555083600860006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260098190555043600a81905550670de0b6b3a7640000600b8190555050505050505061077c565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006101888261015d565b9050919050565b6101988161017d565b81146101a357600080fd5b50565b6000815190506101b58161018f565b92915050565b60006101c68261017d565b9050919050565b6101d6816101bb565b81146101e157600080fd5b50565b6000815190506101f3816101cd565b92915050565b60006102048261017d565b9050919050565b610214816101f9565b811461021f57600080fd5b50565b6000815190506102318161020b565b92915050565b6000819050919050565b61024a81610237565b811461025557600080fd5b50565b60008151905061026781610241565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6102c082610277565b810181811067ffffffffffffffff821117156102df576102de610288565b5b80604052505050565b60006102f2610149565b90506102fe82826102b7565b919050565b600067ffffffffffffffff82111561031e5761031d610288565b5b61032782610277565b9050602081019050919050565b60005b83811015610352578082015181840152602081019050610337565b60008484015250505050565b600061037161036c84610303565b6102e8565b90508281526020810184848401111561038d5761038c610272565b5b610398848285610334565b509392505050565b600082601f8301126103b5576103b461026d565b5b81516103c584826020860161035e565b91505092915050565b60008060008060008060c087890312156103eb576103ea610153565b5b60006103f989828a016101a6565b965050602061040a89828a016101e4565b955050604061041b89828a01610222565b945050606061042c89828a01610258565b935050608087015167ffffffffffffffff81111561044d5761044c610158565b5b61045989828a016103a0565b92505060a087015167ffffffffffffffff81111561047a57610479610158565b5b61048689828a016103a0565b9150509295509295509295565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806104e557607f821691505b6020821081036104f8576104f761049e565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026105607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610523565b61056a8683610523565b95508019841693508086168417925050509392505050565b6000819050919050565b60006105a76105a261059d84610237565b610582565b610237565b9050919050565b6000819050919050565b6105c18361058c565b6105d56105cd826105ae565b848454610530565b825550505050565b600090565b6105ea6105dd565b6105f58184846105b8565b505050565b5b818110156106195761060e6000826105e2565b6001810190506105fb565b5050565b601f82111561065e5761062f816104fe565b61063884610513565b81016020851015610647578190505b61065b61065385610513565b8301826105fa565b50505b505050565b600082821c905092915050565b600061068160001984600802610663565b1980831691505092915050565b600061069a8383610670565b9150826002028217905092915050565b6106b382610493565b67ffffffffffffffff8111156106cc576106cb610288565b5b6106d682546104cd565b6106e182828561061d565b600060209050601f8311600181146107145760008415610702578287015190505b61070c858261068e565b865550610774565b601f198416610722866104fe565b60005b8281101561074a57848901518255600182019150602085019450602081019050610725565b868310156107675784890151610763601f891682610670565b8355505b6001600288020188555050505b505050505050565b6128bd8061078b6000396000f3fe608060405234801561001057600080fd5b506004361061014d5760003560e01c80636f307dc3116100c3578063a9059cbb1161007c578063a9059cbb146103aa578063aa5af0fd146103da578063c5ebeaec146103f8578063db006a7514610428578063dd62ed3e14610458578063f3fdb15a146104885761014d565b80636f307dc3146102d257806370a08231146102f05780638f840ddd1461032057806395d89b411461033e578063a0712d681461035c578063a6afed951461038c5761014d565b806323b872dd1161011557806323b872dd1461020c578063313ce5671461023c5780633b1d21a21461025a57806347bd3718146102785780635fe3b567146102965780636c540baf146102b45761014d565b806306fdde0314610152578063095ea7b3146101705780630e752702146101a0578063173b9904146101d057806318160ddd146101ee575b600080fd5b61015a6104a6565b6040516101679190611ece565b60405180910390f35b61018a60048036038101906101859190611f89565b610538565b6040516101979190611fe4565b60405180910390f35b6101ba60048036038101906101b59190611fff565b61055b565b6040516101c7919061203b565b60405180910390f35b6101d8610586565b6040516101e5919061203b565b60405180910390f35b6101f661058c565b604051610203919061203b565b60405180910390f35b61022660048036038101906102219190612056565b610596565b6040516102339190611fe4565b60405180910390f35b6102446105c5565b60405161025191906120c5565b60405180910390f35b6102626105ce565b60405161026f919061203b565b60405180910390f35b610280610671565b60405161028d919061203b565b60405180910390f35b61029e610677565b6040516102ab919061213f565b60405180910390f35b6102bc61069d565b6040516102c9919061203b565b60405180910390f35b6102da6106a3565b6040516102e79190612169565b60405180910390f35b61030a60048036038101906103059190612184565b6106c9565b604051610317919061203b565b60405180910390f35b610328610711565b604051610335919061203b565b60405180910390f35b610346610717565b6040516103539190611ece565b60405180910390f35b61037660048036038101906103719190611fff565b6107a9565b604051610383919061203b565b60405180910390f35b610394610813565b6040516103a1919061203b565b60405180910390f35b6103c460048036038101906103bf9190611f89565b610a5f565b6040516103d19190611fe4565b60405180910390f35b6103e2610a82565b6040516103ef919061203b565b60405180910390f35b610412600480360381019061040d9190611fff565b610a88565b60405161041f919061203b565b60405180910390f35b610442600480360381019061043d9190611fff565b610ab3565b60405161044f919061203b565b60405180910390f35b610472600480360381019061046d91906121b1565b610ade565b60405161047f919061203b565b60405180910390f35b610490610b65565b60405161049d9190612212565b60405180910390f35b6060600380546104b59061225c565b80601f01602080910402602001604051908101604052809291908181526020018280546104e19061225c565b801561052e5780601f106105035761010080835404028352916020019161052e565b820191906000526020600020905b81548152906001019060200180831161051157829003601f168201915b5050505050905090565b600080610543610b8b565b9050610550818585610b93565b600191505092915050565b6000610565610ba5565b61056d610813565b5061057782610beb565b9050610581610df2565b919050565b60095481565b6000600254905090565b6000806105a1610b8b565b90506105ae858285610dfc565b6105b9858585610e91565b60019150509392505050565b60006012905090565b6000600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b815260040161062b9190612169565b602060405180830381865afa158015610648573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061066c91906122a2565b905090565b600c5481565b600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600a5481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600d5481565b6060600480546107269061225c565b80601f01602080910402602001604051908101604052809291908181526020018280546107529061225c565b801561079f5780601f106107745761010080835404028352916020019161079f565b820191906000526020600020905b81548152906001019060200180831161078257829003601f168201915b5050505050905090565b60006107b3610ba5565b6107f26040518060400160405280600a81526020017f6d696e74416d6f756e740000000000000000000000000000000000000000000081525083610f85565b6107fa610813565b5061080482611021565b905061080e610df2565b919050565b6000804390506000600a54905081810361083257600092505050610a5c565b600061083c6105ce565b90506000600c5490506000600d5490506000600b5490506000600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166315f240538686866040518463ffffffff1660e01b81526004016108b4939291906122cf565b602060405180830381865afa1580156108d1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108f591906122a2565b905065048c27395000811115610940576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161093790612352565b60405180910390fd5b6000868861094e91906123a1565b90506000818361095e91906123d5565b90506000670de0b6b3a7640000878361097791906123d5565b6109819190612446565b9050600087826109919190612477565b9050600087670de0b6b3a7640000846009546109ad91906123d5565b6109b79190612446565b6109c19190612477565b9050600087670de0b6b3a764000089876109db91906123d5565b6109e59190612446565b6109ef9190612477565b90508c600a8190555080600b8190555082600c8190555081600d819055507f4dec04e750ca11537cabcd8a9eab06494de08da3735bc8871cd41250e190bc048b858386604051610a4294939291906124ab565b60405180910390a160009d50505050505050505050505050505b90565b600080610a6a610b8b565b9050610a77818585610e91565b600191505092915050565b600b5481565b6000610a92610ba5565b610a9a610813565b50610aa4826111d8565b9050610aae610df2565b919050565b6000610abd610ba5565b610ac5610813565b50610acf82611508565b9050610ad9610df2565b919050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600033905090565b610ba083838360016117f1565b505050565b600260055403610be1576040517f3ee5aeb500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6002600581905550565b600080610bf7336119c8565b90506000818411610c085783610c0a565b815b9050600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330846040518463ffffffff1660e01b8152600401610c6b939291906124f0565b6020604051808303816000875af1158015610c8a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cae9190612553565b610ced576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ce4906125cc565b60405180910390fd5b60008183610cfb91906123a1565b9050600082600c54610d0d91906123a1565b905081601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000181905550600b54601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001018190555080600c819055507f1a2a22cb034d26d1854bdc6666a5b91fe25efbbb5dcad3b0355478d6f5c362a13333858585604051610ddd9594939291906125ec565b60405180910390a16000945050505050919050565b6001600581905550565b6000610e088484610ade565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811015610e8b5781811015610e7b578281836040517ffb8f41b2000000000000000000000000000000000000000000000000000000008152600401610e729392919061263f565b60405180910390fd5b610e8a848484840360006117f1565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610f035760006040517f96c6fd1e000000000000000000000000000000000000000000000000000000008152600401610efa9190612169565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610f755760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401610f6c9190612169565b60405180910390fd5b610f80838383611a4c565b505050565b61101d8282604051602401610f9b929190612676565b6040516020818303038152906040527fb60e72cc000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050611c71565b5050565b60008061102c611c8b565b9050600081670de0b6b3a76400008561104591906123d5565b61104f9190612446565b9050600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330876040518463ffffffff1660e01b81526004016110b0939291906124f0565b6020604051808303816000875af11580156110cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110f39190612553565b611132576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611129906125cc565b60405180910390fd5b80600e60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546111819190612477565b925050819055506111923382611d04565b7f4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f3385836040516111c59392919061263f565b60405180910390a1600092505050919050565b600080600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663da3d454c3033866040518463ffffffff1660e01b815260040161123a939291906124f0565b6020604051808303816000875af1158015611259573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061127d91906122a2565b9050600081146112c2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016112b9906126f2565b60405180910390fd5b826112cb6105ce565b101561130c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113039061275e565b60405180910390fd5b6000601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050611358336119c8565b8160000181905550600b548160010181905550600084826000015461137d9190612477565b9050600085600c5461138f9190612477565b905081601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555080600c81905550600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33886040518363ffffffff1660e01b815260040161143c92919061277e565b6020604051808303816000875af115801561145b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061147f9190612553565b6114be576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114b5906125cc565b60405180910390fd5b7f13ed6866d4e1ee6da46f845c46d7e54120883d75c5ea9a2dacc1c4ca8984ab80338784846040516114f394939291906127a7565b60405180910390a16000945050505050919050565b600080611513611c8b565b90506000670de0b6b3a7640000828561152c91906123d5565b6115369190612446565b9050806115416105ce565b1015611582576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115799061275e565b60405180910390fd5b6000600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663eabe7d913033886040518463ffffffff1660e01b81526004016115e3939291906124f0565b6020604051808303816000875af1158015611602573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061162691906122a2565b90506000811461166b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161166290612838565b60405180910390fd5b84600e60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546116ba91906123a1565b925050819055506116cb3386611d86565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33846040518363ffffffff1660e01b815260040161172892919061277e565b6020604051808303816000875af1158015611747573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061176b9190612553565b6117aa576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016117a1906125cc565b60405180910390fd5b7fe5b754fb1abb7f01b499791d0b820ae3b6af3424ac1c59768edb53f4ec31a9293383876040516117dd9392919061263f565b60405180910390a160009350505050919050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036118635760006040517fe602df0500000000000000000000000000000000000000000000000000000000815260040161185a9190612169565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036118d55760006040517f94280d620000000000000000000000000000000000000000000000000000000081526004016118cc9190612169565b60405180910390fd5b81600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555080156119c2578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516119b9919061203b565b60405180910390a35b50505050565b600080601060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000816000015403611a22576000915050611a47565b8060010154600b548260000154611a3991906123d5565b611a439190612446565b9150505b919050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603611a9e578060026000828254611a929190612477565b92505081905550611b71565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015611b2a578381836040517fe450d38c000000000000000000000000000000000000000000000000000000008152600401611b219392919061263f565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611bba5780600260008282540392505081905550611c07565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051611c64919061203b565b60405180910390a3505050565b611c8881611c80611e08611e29565b63ffffffff16565b50565b600080611c9661058c565b905060008103611cb157670de0b6b3a7640000915050611d01565b6000611cbb6105ce565b90506000600d54600c5483611cd09190612477565b611cda91906123a1565b905082670de0b6b3a764000082611cf191906123d5565b611cfb9190612446565b93505050505b90565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611d765760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401611d6d9190612169565b60405180910390fd5b611d8260008383611a4c565b5050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611df85760006040517f96c6fd1e000000000000000000000000000000000000000000000000000000008152600401611def91902169565b60405180910390fd5b611e0482600083611a4c565b5050565b60006a636f6e736f6c652e6c6f679050600080835160208501845afa505050565b611e34819050919050565b611e3c612858565b565b600081519050919050565b600082825260208201905092915050565b60005b83811015611e78578082015181840152602081019050611e5d565b60008484015250505050565b6000601f19601f8301169050919050565b6000611ea082611e3e565b611eaa8185611e49565b9350611eba818560208601611e5a565b611ec381611e84565b840191505092915050565b60006020820190508181036000830152611ee88184611e95565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000611f2082611ef5565b9050919050565b611f3081611f15565b8114611f3b57600080fd5b50565b600081359050611f4d81611f27565b92915050565b6000819050919050565b611f6681611f53565b8114611f7157600080fd5b50565b600081359050611f8381611f5d565b92915050565b60008060408385031215611fa057611f9f611ef0565b5b6000611fae85828601611f3e565b9250506020611fbf85828601611f74565b9150509250929050565b60008115159050919050565b611fde81611fc9565b82525050565b6000602082019050611ff96000830184611fd5565b92915050565b60006020828403121561201557612014611ef0565b5b600061202384828501611f74565b91505092915050565b61203581611f53565b82525050565b6000602082019050612050600083018461202c565b92915050565b60008060006060848603121561206f5761206e611ef0565b5b600061207d86828701611f3e565b935050602061208e86828701611f3e565b925050604061209f86828701611f74565b9150509250925092565b600060ff82169050919050565b6120bf816120a9565b82525050565b60006020820190506120da60008301846120b6565b92915050565b6000819050919050565b60006121056121006120fb84611ef5565b6120e0565b611ef5565b9050919050565b6000612117826120ea565b9050919050565b60006121298261210c565b9050919050565b6121398161211e565b82525050565b60006020820190506121546000830184612130565b92915050565b61216381611f15565b82525050565b600060208201905061217e600083018461215a565b92915050565b60006020828403121561219a57612199611ef0565b5b60006121a884828501611f3e565b91505092915050565b600080604083850312156121c8576121c7611ef0565b5b60006121d685828601611f3e565b92505060206121e785828601611f3e565b9150509250929050565b60006121fc8261210c565b9050919050565b61220c816121f1565b82525050565b60006020820190506122276000830184612203565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061227457607f821691505b6020821081036122875761228661222d565b5b50919050565b60008151905061229c81611f5d565b92915050565b6000602082840312156122b8576122b7611ef0565b5b60006122c68482850161228d565b91505092915050565b60006060820190506122e4600083018661202c565b6122f1602083018561202c565b6122fe604083018461202c565b949350505050565b7f426f72726f772072617465206973206162737572646c79206869676800000000600082015250565b600061233c601c83611e49565b915061234782612306565b602082019050919050565b6000602082019050818103600083015261236b8161232f565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006123ac82611f53565b91506123b783611f53565b92508282039050818111156123cf576123ce612372565b5b92915050565b60006123e082611f53565b91506123eb83611f53565b92508282026123f981611f53565b915082820484148315176124105761240f612372565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061245182611f53565b915061245c83611f53565b92508261246c5761246b612417565b5b828204905092915050565b600061248282611f53565b915061248d83611f53565b92508282019050808211156124a5576124a4612372565b5b92915050565b60006080820190506124c0600083018761202c565b6124cd602083018661202c565b6124da604083018561202c565b6124e7606083018461202c565b95945050505050565b6000606082019050612505600083018661215a565b612512602083018561215a565b61251f604083018461202c565b949350505050565b61253081611fc9565b811461253b57600080fd5b50565b60008151905061254d81612527565b92915050565b60006020828403121561256957612568611ef0565b5b60006125778482850161253e565b91505092915050565b7f5472616e73666572206661696c65640000000000000000000000000000000000600082015250565b60006125b6600f83611e49565b91506125c182612580565b602082019050919050565b600060208201905081810360008301526125e5816125a9565b9050919050565b600060a082019050612601600083018861215a565b61260e602083018761215a565b61261b604083018661202c565b612628606083018561202c565b612635608083018461202c565b9695505050505050565b6000606082019050612654600083018661215a565b612661602083018561202c565b61266e604083018461202c565b949350505050565b600060408201905081810360008301526126908185611e95565b905061269f602083018461202c565b9392505050565b7f426f72726f77206e6f7420616c6c6f7765640000000000000000000000000000600082015250565b60006126dc601283611e49565b91506126e7826126a6565b602082019050919050565b6000602082019050818103600083015261270b816126cf565b9050919050565b7f496e73756666696369656e742063617368000000000000000000000000000000600082015250565b6000612748601183611e49565b915061275382612712565b602082019050919050565b600060208201905081810360008301526127778161273b565b9050919050565b6000604082019050612793600083018561215a565b6127a0602083018461202c565b9392505050565b60006080820190506127bc600083018761215a565b6127c9602083018661202c565b6127d6604083018561202c565b6127e3606083018461202c565b95945050505050565b7f52656465656d206e6f7420616c6c6f7765640000000000000000000000000000600082015250565b6000612822601283611e49565b915061282d826127ec565b602082019050919050565b6000602082019050818103600083015261285181612815565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052605160045260246000fd5b5056fea2646970667358221220811b9ee197664658aae1f88846e5ce2ab89ca03d448fadf8c61655744122776764736f6c634300081c0033";

export default function Compounder() {
  const [formData, setFormData] = useState({
    underlying: "",
    comptroller: "",
    interestRateModel: "",
    reserveFactorMantissa: "200000000000000000", // 20%
    name: "",
    symbol: "",
  });
  const [isDeploying, setIsDeploying] = useState(false);
  const [deploymentResult, setDeploymentResult] = useState<{
    success: boolean;
    message: string;
    contractAddress?: string;
    txHash?: string;
  } | null>(null);

  const handleInputChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const validateAddress = (address: string): boolean => {
    try {
      return ethers.isAddress(address);
    } catch {
      return false;
    }
  };

  const validateInputs = (): string | null => {
    if (!formData.underlying || !validateAddress(formData.underlying)) {
      return "올바른 기초 토큰 주소를 입력해주세요.";
    }
    if (!formData.comptroller || !validateAddress(formData.comptroller)) {
      return "올바른 컨트롤러 주소를 입력해주세요.";
    }
    if (!formData.interestRateModel || !validateAddress(formData.interestRateModel)) {
      return "올바른 금리 모델 주소를 입력해주세요.";
    }
    if (!formData.name.trim()) {
      return "토큰 이름을 입력해주세요.";
    }
    if (!formData.symbol.trim()) {
      return "토큰 심볼을 입력해주세요.";
    }
    
    // Reserve factor 검증 (0-100% 사이)
    try {
      const reserveFactor = BigInt(formData.reserveFactorMantissa);
      if (reserveFactor < 0n || reserveFactor > BigInt("1000000000000000000")) { // 100%
        return "리저브 팩터는 0-1000000000000000000 (100%) 사이여야 합니다.";
      }
    } catch {
      return "올바른 리저브 팩터 값을 입력해주세요.";
    }
    
    return null;
  };

  const checkContractsExist = async (provider: ethers.BrowserProvider): Promise<string | null> => {
    try {
      // 컨트롤러 컨트랙트 확인
      const comptrollerCode = await provider.getCode(formData.comptroller);
      if (comptrollerCode === "0x") {
        return "컨트롤러 주소에 컨트랙트가 배포되어 있지 않습니다.";
      }

      // 금리 모델 컨트랙트 확인
      const interestRateModelCode = await provider.getCode(formData.interestRateModel);
      if (interestRateModelCode === "0x") {
        return "금리 모델 주소에 컨트랙트가 배포되어 있지 않습니다.";
      }

      // 기초 토큰 컨트랙트 확인
      const underlyingCode = await provider.getCode(formData.underlying);
      if (underlyingCode === "0x") {
        return "기초 토큰 주소에 컨트랙트가 배포되어 있지 않습니다.";
      }

      return null;
    } catch (error: any) {
      return `컨트랙트 확인 중 오류가 발생했습니다: ${error.message}`;
    }
  };

  const deployCToken = async () => {
    if (!window.ethereum) {
      setDeploymentResult({
        success: false,
        message: "MetaMask가 설치되지 않았습니다.",
      });
      return;
    }

    // 입력값 검증
    const validationError = validateInputs();
    if (validationError) {
      setDeploymentResult({
        success: false,
        message: validationError,
      });
      return;
    }

    setIsDeploying(true);
    setDeploymentResult(null);

    try {
      const provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();

      // 컨트랙트 존재 여부 확인
      const contractCheckError = await checkContractsExist(provider);
      if (contractCheckError) {
        setDeploymentResult({
          success: false,
          message: contractCheckError,
        });
        return;
      }

      const factory = new ethers.ContractFactory(CTOKEN_ABI, CTOKEN_BYTECODE, signer);

      // 가스 예측
      try {
        const estimatedGas = await factory.getDeployTransaction(
          formData.underlying,
          formData.comptroller,
          formData.interestRateModel,
          formData.reserveFactorMantissa,
          formData.name,
          formData.symbol
        ).then(tx => provider.estimateGas(tx));
        
        console.log("예상 가스:", estimatedGas.toString());
      } catch (gasError: any) {
        setDeploymentResult({
          success: false,
          message: `가스 예측 실패: ${gasError.reason || gasError.message}. 컨트랙트 파라미터를 확인해주세요.`,
        });
        return;
      }

      const contract = await factory.deploy(
        formData.underlying,
        formData.comptroller,
        formData.interestRateModel,
        formData.reserveFactorMantissa,
        formData.name,
        formData.symbol
      );

      const receipt = await contract.deploymentTransaction()?.wait();

      setDeploymentResult({
        success: true,
        message: "CToken 컨트랙트가 성공적으로 배포되었습니다!",
        contractAddress: await contract.getAddress(),
        txHash: receipt?.hash || "",
      });
    } catch (error: any) {
      let errorMessage = "알 수 없는 오류가 발생했습니다.";
      
      if (error.code === "CALL_EXCEPTION") {
        errorMessage = "컨트랙트 실행 실패: 생성자 파라미터를 확인해주세요.";
      } else if (error.code === "INSUFFICIENT_FUNDS") {
        errorMessage = "잔액이 부족합니다.";
      } else if (error.code === "USER_REJECTED") {
        errorMessage = "사용자가 트랜잭션을 거부했습니다.";
      } else if (error.reason) {
        errorMessage = `배포 실패: ${error.reason}`;
      } else if (error.message) {
        errorMessage = `배포 실패: ${error.message}`;
      }
      
      setDeploymentResult({
        success: false,
        message: errorMessage,
      });
    } finally {
      setIsDeploying(false);
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="max-w-4xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2 flex items-center justify-center space-x-3">
            <TrendingUp className="w-8 h-8 text-blue-600" />
            <span>컴파운더</span>
          </h1>
          <p className="text-gray-600">
            Compound DeFi 프로토콜 - CToken 배포
          </p>
        </div>

        <div className="bg-white rounded-lg shadow-lg p-6">
          <div className="flex items-center space-x-3 mb-6">
            <Plus className="w-6 h-6 text-green-600" />
            <h2 className="text-xl font-semibold text-gray-900">새 CToken 배포</h2>
          </div>

          <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
            <h3 className="font-semibold text-yellow-800 mb-2">사전 준비사항</h3>
            <ul className="text-sm text-yellow-700 space-y-1">
              <li>• Comptroller 컨트랙트가 배포되어 있어야 합니다</li>
              <li>• InterestRateModel 컨트랙트가 배포되어 있어야 합니다</li>
              <li>• 기초 토큰(Underlying) 컨트랙트가 배포되어 있어야 합니다</li>
              <li>• 충분한 가스 수수료가 있어야 합니다</li>
            </ul>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                기초 토큰 주소 (Underlying)
              </label>
              <input
                type="text"
                placeholder="0x..."
                className={`w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                  formData.underlying && !validateAddress(formData.underlying)
                    ? "border-red-300 bg-red-50"
                    : "border-gray-300"
                }`}
                value={formData.underlying}
                onChange={(e) => handleInputChange("underlying", e.target.value)}
              />
              {formData.underlying && !validateAddress(formData.underlying) && (
                <p className="text-xs text-red-600 mt-1">올바른 이더리움 주소를 입력해주세요.</p>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                컨트롤러 주소 (Comptroller)
              </label>
              <input
                type="text"
                placeholder="0x..."
                className={`w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                  formData.comptroller && !validateAddress(formData.comptroller)
                    ? "border-red-300 bg-red-50"
                    : "border-gray-300"
                }`}
                value={formData.comptroller}
                onChange={(e) => handleInputChange("comptroller", e.target.value)}
              />
              {formData.comptroller && !validateAddress(formData.comptroller) && (
                <p className="text-xs text-red-600 mt-1">올바른 이더리움 주소를 입력해주세요.</p>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                금리 모델 주소 (Interest Rate Model)
              </label>
              <input
                type="text"
                placeholder="0x..."
                className={`w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                  formData.interestRateModel && !validateAddress(formData.interestRateModel)
                    ? "border-red-300 bg-red-50"
                    : "border-gray-300"
                }`}
                value={formData.interestRateModel}
                onChange={(e) => handleInputChange("interestRateModel", e.target.value)}
              />
              {formData.interestRateModel && !validateAddress(formData.interestRateModel) && (
                <p className="text-xs text-red-600 mt-1">올바른 이더리움 주소를 입력해주세요.</p>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                리저브 팩터 (Reserve Factor Mantissa)
              </label>
              <input
                type="text"
                placeholder="200000000000000000"
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={formData.reserveFactorMantissa}
                onChange={(e) => handleInputChange("reserveFactorMantissa", e.target.value)}
              />
              <p className="text-xs text-gray-500 mt-1">기본값: 200000000000000000 (20%)</p>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                토큰 이름 (Name)
              </label>
              <input
                type="text"
                placeholder="예: Compound Dai"
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={formData.name}
                onChange={(e) => handleInputChange("name", e.target.value)}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                토큰 심볼 (Symbol)
              </label>
              <input
                type="text"
                placeholder="예: cDAI"
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={formData.symbol}
                onChange={(e) => handleInputChange("symbol", e.target.value)}
              />
            </div>
          </div>

          <div className="mt-6">
            <button
              onClick={deployCToken}
              disabled={isDeploying || !formData.underlying || !formData.comptroller || !formData.interestRateModel || !formData.name || !formData.symbol}
              className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
            >
              {isDeploying ? (
                <>
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  <span>배포 중...</span>
                </>
              ) : (
                <>
                  <Coins className="w-5 h-5" />
                  <span>CToken 배포하기</span>
                </>
              )}
            </button>
          </div>

          {deploymentResult && (
            <div className={`mt-6 p-4 rounded-md ${
              deploymentResult.success 
                ? "bg-green-50 border border-green-200" 
                : "bg-red-50 border border-red-200"
            }`}>
              <div className={`font-medium ${
                deploymentResult.success ? "text-green-800" : "text-red-800"
              }`}>
                {deploymentResult.message}
              </div>
              {deploymentResult.success && deploymentResult.contractAddress && (
                <div className="mt-2 text-sm text-gray-600">
                  <div><strong>컨트랙트 주소:</strong> {deploymentResult.contractAddress}</div>
                  {deploymentResult.txHash && (
                    <div><strong>트랜잭션 해시:</strong> {deploymentResult.txHash}</div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}